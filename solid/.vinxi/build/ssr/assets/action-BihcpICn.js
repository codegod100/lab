import{H3Event as J,setResponseStatus as Fe,setHeader as je,getRequestIP as We,getResponseStatus as Ie,getResponseStatusText as Be,getResponseHeader as Ue,setResponseHeader as ke,removeResponseHeader as Me,appendResponseHeader as De,getResponseHeaders as Ke,getRequestURL as Ne,getRequestWebStream as Xe,sendRedirect as ze,getCookie as Ge,setCookie as Je}from"h3";import{AsyncLocalStorage as Ye}from"node:async_hooks";import{getOwner as V,runWithOwner as de,createMemo as S,useContext as pe,createContext as ge,createSignal as P,createRenderEffect as Qe,on as me,startTransition as $,resetErrorBoundaries as Ve,batch as Ze,untrack as et,createComponent as tt,getListener as nt,onCleanup as ye,sharedConfig as A,$TRACK as rt}from"solid-js";import{isServer as R,getRequestEvent as E}from"solid-js/web";function st(e={}){let t,n=!1;const r=o=>{if(t&&t!==o)throw new Error("Context conflict")};let s;if(e.asyncContext){const o=e.AsyncLocalStorage||globalThis.AsyncLocalStorage;o?s=new o:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const a=()=>{if(s){const o=s.getStore();if(o!==void 0)return o}return t};return{use:()=>{const o=a();if(o===void 0)throw new Error("Context is not available");return o},tryUse:()=>a(),set:(o,c)=>{c||r(o),t=o,n=!0},unset:()=>{t=void 0,n=!1},call:(o,c)=>{r(o),t=o;try{return s?s.run(o,c):c()}finally{n||(t=void 0)}},async callAsync(o,c){t=o;const p=()=>{t=o},d=()=>t===o?p:void 0;ce.add(d);try{const u=s?s.run(o,c):c();return n||(t=void 0),await u}finally{ce.delete(d)}}}}function ot(e={}){const t={};return{get(n,r={}){return t[n]||(t[n]=st({...e,...r})),t[n]}}}const N=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof global<"u"?global:typeof window<"u"?window:{},ae="__unctx__",at=N[ae]||(N[ae]=ot()),it=(e,t={})=>at.get(e,t),ie="__unctx_async_handlers__",ce=N[ie]||(N[ie]=new Set);function ct(e){let t;const n=Re(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...r,body:e.node.req.body}):new Request(n,{...r,get body(){return t||(t=mt(e),t)}})}function ut(e){return e.web??={request:ct(e),url:Re(e)},e.web.request}function lt(){return bt()}const we=Symbol("$HTTPEvent");function ft(e){return typeof e=="object"&&(e instanceof J||e?.[we]instanceof J||e?.__is_event__===!0)}function b(e){return function(...t){let n=t[0];if(ft(n))t[0]=n instanceof J||n.__is_event__?n:n[we];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(n=lt(),!n)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(n)}return e(...t)}}const Re=b(Ne),ht=b(We),ue=b(Fe),le=b(Ie),dt=b(Be),D=b(Ke),fe=b(Ue),pt=b(ke),gt=b(De),Zt=b(ze),en=b(Ge),tn=b(Je),nn=b(je),mt=b(Xe),yt=b(Me),wt=b(ut);function Rt(){return it("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:Ye})}function bt(){return Rt().use().event}const X="solidFetchEvent";function vt(e){return{request:wt(e),response:St(e),clientAddress:ht(e),locals:{},nativeEvent:e}}function rn(e){return{...e}}function sn(e){if(!e.context[X]){const t=vt(e);e.context[X]=t}return e.context[X]}class xt{event;constructor(t){this.event=t}get(t){const n=fe(this.event,t);return Array.isArray(n)?n.join(", "):n||null}has(t){return this.get(t)!==void 0}set(t,n){return pt(this.event,t,n)}delete(t){return yt(this.event,t)}append(t,n){gt(this.event,t,n)}getSetCookie(){const t=fe(this.event,"Set-Cookie");return Array.isArray(t)?t:[t]}forEach(t){return Object.entries(D(this.event)).forEach(([n,r])=>t(Array.isArray(r)?r.join(", "):r,n,this))}entries(){return Object.entries(D(this.event)).map(([t,n])=>[t,Array.isArray(n)?n.join(", "):n])[Symbol.iterator]()}keys(){return Object.keys(D(this.event))[Symbol.iterator]()}values(){return Object.values(D(this.event)).map(t=>Array.isArray(t)?t.join(", "):t)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function St(e){return{get status(){return le(e)},set status(t){ue(e,t)},get statusText(){return dt(e)},set statusText(t){ue(e,le(e),t)},headers:new xt(e)}}function At(){let e=new Set;function t(s){return e.add(s),()=>e.delete(s)}let n=!1;function r(s,a){if(n)return!(n=!1);const o={to:s,options:a,defaultPrevented:!1,preventDefault:()=>o.defaultPrevented=!0};for(const c of e)c.listener({...o,from:c.location,retry:p=>{p&&(n=!0),c.navigate(s,{...a,resolve:!1})}});return!o.defaultPrevented}return{subscribe:t,confirm:r}}let Y;function be(){(!window.history.state||window.history.state._depth==null)&&window.history.replaceState({...window.history.state,_depth:window.history.length-1},""),Y=window.history.state._depth}R||be();function on(e){return{...e,_depth:window.history.state&&window.history.state._depth}}function an(e,t){let n=!1;return()=>{const r=Y;be();const s=r==null?null:Y-r;if(n){n=!1;return}s&&t(s)?(n=!0,window.history.go(-s)):e()}}const Ct=/^(?:[a-z0-9]+:)?\/\//i,Pt=/^\/+|(\/)\/+$/g,ve="http://sr";function q(e,t=!1){const n=e.replace(Pt,"$1");return n?t||/^[?#]/.test(n)?n:"/"+n:""}function K(e,t,n){if(Ct.test(t))return;const r=q(e),s=n&&q(n);let a="";return!s||t.startsWith("/")?a=r:s.toLowerCase().indexOf(r.toLowerCase())!==0?a=r+s:a=s,(a||"/")+q(t,!a)}function Et(e,t){if(e==null)throw new Error(t);return e}function _t(e,t){return q(e).replace(/\/*(\*.*)?$/g,"")+q(t)}function xe(e){const t={};return e.searchParams.forEach((n,r)=>{r in t?Array.isArray(t[r])?t[r].push(n):t[r]=[t[r],n]:t[r]=n}),t}function Ht(e,t,n){const[r,s]=e.split("/*",2),a=r.split("/").filter(Boolean),o=a.length;return c=>{const p=c.split("/").filter(Boolean),d=p.length-o;if(d<0||d>0&&s===void 0&&!t)return null;const u={path:o?"":"/",params:{}},i=g=>n===void 0?void 0:n[g];for(let g=0;g<o;g++){const f=a[g],y=f[0]===":",l=y?p[g]:p[g].toLowerCase(),w=y?f.slice(1):f.toLowerCase();if(y&&z(l,i(w)))u.params[w]=l;else if(y||!z(l,w))return null;u.path+=`/${l}`}if(s){const g=d?p.slice(-d).join("/"):"";if(z(g,i(s)))u.params[s]=g;else return null}return u}}function z(e,t){const n=r=>r===e;return t===void 0?!0:typeof t=="string"?n(t):typeof t=="function"?t(e):Array.isArray(t)?t.some(n):t instanceof RegExp?t.test(e):!1}function Ot(e){const[t,n]=e.pattern.split("/*",2),r=t.split("/").filter(Boolean);return r.reduce((s,a)=>s+(a.startsWith(":")?2:3),r.length-(n===void 0?0:1))}function Se(e){const t=new Map,n=V();return new Proxy({},{get(r,s){return t.has(s)||de(n,()=>t.set(s,S(()=>e()[s]))),t.get(s)()},getOwnPropertyDescriptor(){return{enumerable:!0,configurable:!0}},ownKeys(){return Reflect.ownKeys(e())}})}function Ae(e){let t=/(\/?\:[^\/]+)\?/.exec(e);if(!t)return[e];let n=e.slice(0,t.index),r=e.slice(t.index+t[0].length);const s=[n,n+=t[1]];for(;t=/^(\/\:[^\/]+)\?/.exec(r);)s.push(n+=t[1]),r=r.slice(t[0].length);return Ae(r).reduce((a,o)=>[...a,...s.map(c=>c+o)],[])}const Lt=100,Tt=ge(),$t=ge(),Z=()=>Et(pe(Tt),"<A> and 'use' router primitives can be only used inside a Route."),qt=()=>Z().navigatorFactory();function Ft(e,t=""){const{component:n,preload:r,load:s,children:a,info:o}=e,c=!a||Array.isArray(a)&&!a.length,p={key:e,component:n,preload:r||s,info:o};return Ce(e.path).reduce((d,u)=>{for(const i of Ae(u)){const g=_t(t,i);let f=c?g:g.split("/*",1)[0];f=f.split("/").map(y=>y.startsWith(":")||y.startsWith("*")?y:encodeURIComponent(y)).join("/"),d.push({...p,originalPath:u,pattern:f,matcher:Ht(f,!c,e.matchFilters)})}return d},[])}function jt(e,t=0){return{routes:e,score:Ot(e[e.length-1])*1e4-t,matcher(n){const r=[];for(let s=e.length-1;s>=0;s--){const a=e[s],o=a.matcher(n);if(!o)return null;r.unshift({...o,route:a})}return r}}}function Ce(e){return Array.isArray(e)?e:[e]}function Wt(e,t="",n=[],r=[]){const s=Ce(e);for(let a=0,o=s.length;a<o;a++){const c=s[a];if(c&&typeof c=="object"){c.hasOwnProperty("path")||(c.path="");const p=Ft(c,t);for(const d of p){n.push(d);const u=Array.isArray(c.children)&&c.children.length===0;if(c.children&&!u)Wt(c.children,d.pattern,n,r);else{const i=jt([...n],r.length);r.push(i)}n.pop()}}}return n.length?r:r.sort((a,o)=>o.score-a.score)}function G(e,t){for(let n=0,r=e.length;n<r;n++){const s=e[n].matcher(t);if(s)return s}return[]}function It(e,t,n){const r=new URL(ve),s=S(u=>{const i=e();try{return new URL(i,r)}catch{return console.error(`Invalid path ${i}`),u}},r,{equals:(u,i)=>u.href===i.href}),a=S(()=>s().pathname),o=S(()=>s().search,!0),c=S(()=>s().hash),p=()=>"",d=me(o,()=>xe(s()));return{get pathname(){return a()},get search(){return o()},get hash(){return c()},get state(){return t()},get key(){return p()},query:n?n(d):Se(d)}}let C;function Bt(){return C}let T=!1;function Ut(){return T}function cn(e){T=e}function un(e,t,n,r={}){const{signal:[s,a],utils:o={}}=e,c=o.parsePath||(h=>h),p=o.renderPath||(h=>h),d=o.beforeLeave||At(),u=K("",r.base||"");if(u===void 0)throw new Error(`${u} is not a valid base path`);u&&!s().value&&a({value:u,replace:!0,scroll:!1});const[i,g]=P(!1);let f;const y=(h,m)=>{m.value===l()&&m.state===v()||(f===void 0&&g(!0),C=h,f=m,$(()=>{f===m&&(w(f.value),I(f.state),Ve(),R||ee[1](x=>x.filter(_=>_.pending)))}).finally(()=>{f===m&&Ze(()=>{C=void 0,h==="navigate"&&Te(f),g(!1),f=void 0})}))},[l,w]=P(s().value),[v,I]=P(s().state),B=It(l,v,o.queryWrapper),U=[],ee=P(R?qe():[]),te=S(()=>typeof r.transformUrl=="function"?G(t(),r.transformUrl(B.pathname)):G(t(),B.pathname)),ne=()=>{const h=te(),m={};for(let x=0;x<h.length;x++)Object.assign(m,h[x].params);return m},He=o.paramsWrapper?o.paramsWrapper(ne,t):Se(ne),re={pattern:u,path:()=>u,outlet:()=>null,resolvePath(h){return K(u,h)}};return Qe(me(s,h=>y("native",h),{defer:!0})),{base:re,location:B,params:He,isRouting:i,renderPath:p,parsePath:c,navigatorFactory:Le,matches:te,beforeLeave:d,preloadRoute:$e,singleFlight:r.singleFlight===void 0?!0:r.singleFlight,submissions:ee};function Oe(h,m,x){et(()=>{if(typeof m=="number"){m&&(o.go?o.go(m):console.warn("Router integration does not support relative routing"));return}const _=!m||m[0]==="?",{replace:k,resolve:H,scroll:M,state:O}={replace:!1,resolve:!_,scroll:!0,...x},L=H?h.resolvePath(m):K(_&&B.pathname||"",m);if(L===void 0)throw new Error(`Path '${m}' is not a routable path`);if(U.length>=Lt)throw new Error("Too many redirects");const se=l();if(L!==se||O!==v())if(R){const oe=E();oe&&(oe.response={status:302,headers:new Headers({Location:L})}),a({value:L,replace:k,scroll:M,state:O})}else d.confirm(L,x)&&(U.push({value:se,replace:k,scroll:M,state:v()}),y("navigate",{value:L,state:O}))})}function Le(h){return h=h||pe($t)||re,(m,x)=>Oe(h,m,x)}function Te(h){const m=U[0];m&&(a({...h,replace:m.replace,scroll:m.scroll}),U.length=0)}function $e(h,m){const x=G(t(),h.pathname),_=C;C="preload";for(let k in x){const{route:H,params:M}=x[k];H.component&&H.component.preload&&H.component.preload();const{preload:O}=H;T=!0,m&&O&&de(n(),()=>O({params:M,location:{pathname:h.pathname,search:h.search,hash:h.hash,query:xe(h),state:null,key:""},intent:"preload"})),T=!1}C=_}function qe(){const h=E();return h&&h.router&&h.router.submission?[h.router.submission]:[]}}function ln(e,t,n,r){const{base:s,location:a,params:o}=e,{pattern:c,component:p,preload:d}=r().route,u=S(()=>r().path);p&&p.preload&&p.preload(),T=!0;const i=d?d({params:o,location:a,intent:C||"initial"}):void 0;return T=!1,{parent:t,pattern:c,path:u,outlet:()=>p?tt(p,{params:o,location:a,data:i,get children(){return n()}}):n(),resolvePath(f){return K(s.path(),f,u())}}}const kt="Location",Mt=5e3,Dt=18e4;let F=new Map;R||setInterval(()=>{const e=Date.now();for(let[t,n]of F.entries())!n[4].count&&e-n[0]>Dt&&F.delete(t)},3e5);function j(){if(!R)return F;const e=E();if(!e)throw new Error("Cannot find cache context");return(e.router||(e.router={})).cache||(e.router.cache=new Map)}function Kt(e,t=!0){return $(()=>{const n=Date.now();Pe(e,r=>{t&&(r[0]=0),r[4][1](n)})})}function Pe(e,t){e&&!Array.isArray(e)&&(e=[e]);for(let n of F.keys())(e===void 0||Ee(n,e))&&t(F.get(n))}function W(e,t){e.GET&&(e=e.GET);const n=(...r)=>{const s=j(),a=Bt(),o=Ut(),p=V()?qt():void 0,d=Date.now(),u=t+Q(r);let i=s.get(u),g;if(R){const l=E();if(l){const w=(l.router||(l.router={})).dataOnly;if(w){const v=l&&(l.router.data||(l.router.data={}));if(v&&u in v)return v[u];if(Array.isArray(w)&&!Ee(u,w))return v[u]=void 0,Promise.resolve()}}}if(nt()&&!R&&(g=!0,ye(()=>i[4].count--)),i&&i[0]&&(R||a==="native"||i[4].count||Date.now()-i[0]<Mt)){g&&(i[4].count++,i[4][0]()),i[3]==="preload"&&a!=="preload"&&(i[0]=d);let l=i[1];return a!=="preload"&&(l="then"in i[1]?i[1].then(y(!1),y(!0)):y(!1)(i[1]),!R&&a==="navigate"&&$(()=>i[4][1](i[0]))),o&&"then"in l&&l.catch(()=>{}),l}let f;if(!R&&A.has&&A.has(u)?(f=A.load(u),delete globalThis._$HY.r[u]):f=e(...r),i?(i[0]=d,i[1]=f,i[3]=a,!R&&a==="navigate"&&$(()=>i[4][1](i[0]))):(s.set(u,i=[d,f,,a,P(d)]),i[4].count=0),g&&(i[4].count++,i[4][0]()),R){const l=E();if(l&&l.router.dataOnly)return l.router.data[u]=f}if(a!=="preload"&&(f="then"in f?f.then(y(!1),y(!0)):y(!1)(f)),o&&"then"in f&&f.catch(()=>{}),R&&A.context&&A.context.async&&!A.context.noHydrate){const l=E();(!l||!l.serverOnly)&&A.context.serialize(u,f)}return f;function y(l){return async w=>{if(w instanceof Response){const v=w.headers.get(kt);if(v!==null){if(p&&v.startsWith("/"))$(()=>{p(v,{replace:!0})});else if(!R)window.location.href=v;else if(R){const I=E();I&&(I.response={status:302,headers:new Headers({Location:v})})}return}w.customBody&&(w=await w.customBody())}if(l)throw w;return i[2]=w,w}}};return n.keyFor=(...r)=>t+Q(r),n.key=t,n}W.get=e=>j().get(e)[2];W.set=(e,t)=>{const n=j(),r=Date.now();let s=n.get(e);s?(s[0]=r,s[1]=Promise.resolve(t),s[2]=t,s[3]="preload"):(n.set(e,s=[r,Promise.resolve(t),t,"preload",P(r)]),s[4].count=0)};W.delete=e=>j().delete(e);W.clear=()=>j().clear();function Ee(e,t){for(let n of t)if(n&&e.startsWith(n))return!0;return!1}function Q(e){return JSON.stringify(e,(t,n)=>Nt(n)?Object.keys(n).sort().reduce((r,s)=>(r[s]=n[s],r),{}):n)}function Nt(e){let t;return e!=null&&typeof e=="object"&&(!(t=Object.getPrototypeOf(e))||t===Object.prototype)}const he=new Map;function Xt(e,t){const n=Z(),r=S(()=>n.submissions[0]().filter(s=>s.url===e.base&&!0));return new Proxy([],{get(s,a){return a===rt?r():a==="pending"?r().some(o=>!o.result):r()[a]},has(s,a){return a in r()}})}function fn(e,t){const n=Xt(e);return new Proxy({},{get(r,s){return n.length===0&&s==="clear"||s==="retry"?()=>{}:n[n.length-1]?.[s]}})}function hn(e){const t=Z();return(...n)=>e.apply({r:t},n)}function dn(e,t={}){function n(...a){const o=this.r,c=this.f,p=(o.singleFlight&&e.withOptions?e.withOptions({headers:{"X-Single-Flight":"true"}}):e)(...a),[d,u]=P();let i;function g(f){return async y=>{const l=await Gt(y,f,o.navigatorFactory());let w=null;if(r.onComplete?.({...i,result:l?.data,error:l?.error,pending:!1,retry(){return w=i.retry()}}),w)return w;if(!l)return i.clear();if(u(l),l.error&&!c)throw l.error;return l.data}}return o.submissions[1](f=>[...f,i={input:a,url:s,get result(){return d()?.data},get error(){return d()?.error},get pending(){return!d()},clear(){o.submissions[1](y=>y.filter(l=>l!==i))},retry(){return u(void 0),e(...a).then(g(),g(!0))}}]),p.then(g(),g(!0))}const r=typeof t=="string"?{name:t}:t,s=e.url||r.name&&`https://action/${r.name}`||(R?"":`https://action/${zt(e.toString())}`);return n.base=s,_e(n,s)}function _e(e,t){return e.toString=()=>{if(!t)throw new Error("Client Actions need explicit names if server rendered");return t},e.with=function(...n){const r=function(...a){return e.call(this,...n,...a)};r.base=e.base;const s=new URL(t,ve);return s.searchParams.set("args",Q(n)),_e(r,(s.origin==="https://action"?s.origin:"")+s.pathname+s.search)},e.url=t,R||(he.set(t,e),V()&&ye(()=>he.delete(t))),e}const zt=e=>e.split("").reduce((t,n)=>(t<<5)-t+n.charCodeAt(0)|0,0);async function Gt(e,t,n){let r,s,a,o;if(e instanceof Response){if(e.headers.has("X-Revalidate")&&(a=e.headers.get("X-Revalidate").split(",")),e.customBody&&(r=s=await e.customBody(),e.headers.has("X-Single-Flight")&&(r=r._$value,delete s._$value,o=Object.keys(s))),e.headers.has("Location")){const c=e.headers.get("Location")||"/";c.startsWith("http")?window.location.href=c:n(c)}}else{if(t)return{error:e};r=e}return Pe(a,c=>c[0]=0),o&&o.forEach(c=>W.set(c,s[c])),await Kt(a,!1),r!=null?{data:r}:void 0}export{Tt as R,sn as a,Zt as b,ue as c,nn as d,Wt as e,un as f,en as g,Bt as h,ln as i,G as j,$t as k,cn as l,ve as m,he as n,At as o,on as p,be as q,an as r,tn as s,rn as t,dn as u,hn as v,fn as w};
